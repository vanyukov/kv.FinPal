# 4. Стратегия оффлайн-синхронизации

Date: 2026-01-06

## Status

Accepted

## Context

Приложение должно работать полностью оффлайн и синхронизироваться при подключении к сети. Необходимо определить стратегию синхронизации и разрешения конфликтов.

## Decision

Принята гибридная стратегия:

1. **Firebase persistence** - для автоматической оффлайн-персистентности Firestore
2. **IndexedDB очередь** - для хранения операций, созданных оффлайн
3. **Optimistic concurrency control** - версионирование документов для предотвращения конфликтов
4. **Ручное разрешение конфликтов** - для критичных операций (баланс счетов)
5. **Автоматическое слияние** - для некритичных полей (описание, теги)

## Rationale

### Гибридный баланс
- Локальный расчет баланса для мгновенного отклика
- Серверная валидация для обеспечения целостности данных

### Ручное разрешение конфликтов
- Пользовательский контроль над критичными операциями
- Прозрачность изменений с разных устройств

### Предварительная агрегация
- Ежедневные сводки через Cloud Functions
- Оптимизация запросов к Firestore

## Consequences

### Положительные
- Полная функциональность оффлайн
- Быстрый отклик UI
- Контроль пользователя над конфликтами
- Оптимизация использования квот Firestore

### Негативные
- Сложность реализации синхронизации
- Необходимость обработки конфликтов
- Дополнительная логика на клиенте и сервере

## Implementation Details

- Очередь синхронизации в IndexedDB
- Service Worker для фоновой синхронизации
- Cloud Functions для валидации и агрегации
- Визуальные индикаторы статуса синхронизации

