# 5. Структура данных в Firestore

Date: 2026-01-06

## Status

Accepted

## Context

Необходимо определить оптимальную структуру коллекций в Firestore для обеспечения безопасности, производительности и масштабируемости.

## Decision

Принята следующая структура:

```
/users/{userId}/
  /accounts/{accountId}
  /categories/{categoryId}
  /tags/{tagId}
  /templates/{templateId}
  /operations/{operationId}
  /settings/{settingKey}
  /reports/{reportId}
  /projects/{projectId}
  /aggregates/{date}
  /conflicts/{conflictId}
```

### Принципы
1. **Мультитенантность** - все данные пользователя в подколлекциях `/users/{userId}/`
2. **Безопасность** - Security Rules на уровне userId
3. **Оптимизация** - композитные индексы для всех запросов
4. **Агрегация** - предварительно вычисленные сводки в `/aggregates/`

## Rationale

### Мультитенантность
- Изоляция данных пользователей
- Простые Security Rules
- Масштабируемость

### Подколлекции вместо корневых коллекций
- Безопасность через правила доступа
- Лучшая организация данных
- Проще управление индексами

### Агрегированные данные
- Снижение количества reads
- Быстрые отчеты
- Оптимизация квот

## Consequences

### Положительные
- Простая безопасность
- Хорошая производительность
- Масштабируемость
- Оптимизация квот

### Негативные
- Нельзя использовать collectionGroup queries без специальных индексов
- Сложнее кросс-пользовательские запросы (не требуется для MVP)

## Security Rules

Все правила проверяют `request.auth.uid == userId` для обеспечения изоляции данных.

