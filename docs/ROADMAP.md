# Roadmap для разработки FinPal (PWA для учета финансов)

## Обзор проекта
**FinPal** — прогрессивное веб-приложение (PWA) для отслеживания личных финансов с акцентом на оффлайн-работу и кроссплатформенность. Приложение позволяет пользователям управлять счетами, операциями, категориями и получать аналитику по расходам/доходам.

**Технологический стек:**
- **Frontend:** React + TypeScript, Material-UI, Zustand, React Router, Recharts
- **Backend/Infrastructure:** Firebase (Auth, Firestore, Cloud Functions, Hosting)
- **Валидация:** Zod (схемы и генерация типов)
- **CI/CD:** GitHub Actions
- **Тестирование:** Jest, PlayWright
- **Мониторинг:** Sentry, Cloud Logging

---

## Дорожная карта разработки

### Milestone 0 (M0): Подготовка и архитектура (2-3 недели)
**Цель:** Создать прочный фундамент для разработки

**Задачи:**
1. **Архитектура проекта**
   - Определить структуру папок (feature-based подход)
   - Настроить абсолютные импорты (`@/components/`)
   - Определить стратегию code splitting для маршрутов

2. **Документация архитектурных решений (ADR)**
   - Создать шаблон для ADR документов
   - Задокументировать ключевые архитектурные решения:
     - Выбор технологического стека
     - Стратегия state management (Zustand vs Redux Toolkit)
     - Подход к оффлайн-синхронизации
     - Структура данных в Firestore
   - Настроить процесс обновления ADR при изменении архитектуры

3. **Настройка окружения**
   - Инициализировать проект: `npm create vite@latest finpal -- --template react-ts`
   - Настроить ESLint + Prettier + Husky для code quality
   - Конфигурировать TypeScript с strict режимом
   - Настроить Zod для валидации и генерации типов

4. **Инфраструктура CI/CD**
   - Настроить GitHub Actions workflow:
     - Линтинг и проверка типов
     - Unit-тесты (Jest)
     - Автодеплой на Firebase Hosting при пуше в main
   - Создать разные окружения (dev, staging, prod)

5. **Базовая конфигурация Firebase**
   - Создать Firebase проект
   - Инициализировать Firebase CLI
   - Настроить базовые Security Rules (deny all по умолчанию)

**Критерии завершения:**
- [ ] Проект запускается через `npm run dev`
- [ ] ESLint/Prettier работают в pre-commit хуках
- [ ] CI pipeline проходит успешно
- [ ] Firebase проект создан и подключен
- [ ] Созданы ADR документы для ключевых архитектурных решений

---

### Milestone 1 (M1): Каркас приложения (3-4 недели)
**Цель:** Реализовать базовую инфраструктуру приложения

**Задачи:**
1. **Настройка Firebase сервисов**
   - Активировать Firestore, Authentication, Hosting
   - Настроить Firestore с оффлайн-персистентностью
   - Создать базовые Security Rules для аутентификации

2. **Система аутентификации**
   - Реализовать вход через Google (Firebase Auth)
   - Создать HOC/хук `useAuth` для защиты роутов
   - Страницы: Login, Register, Forgot Password

3. **State Management (Zustand)**
   - Создать store для пользователя (`useAuthStore`)
   - Создать store для UI состояния (`useUIStore`)
   - Настроить персистентность для оффлайн-доступа

4. **Оффлайн-инфраструктура**
   - Настроить Service Worker с Workbox
   - Реализовать кеширование статических ресурсов
   - Добавить индикатор онлайн/оффлайн статуса

5. **Базовый UI каркас**
   - Создать основной Layout компонент
   - Реализовать верхнюю панель с балансом
   - Создать боковое меню для навигации
   - Настроить тему Material-UI

6. **Валидация и типизация**
   - Настроить Zod схемы для валидации форм
   - Создать утилиты для генерации TypeScript типов из Zod схем
   - Реализовать валидацию API контрактов (Firebase Functions)
   - Настроить end-to-end type safety (backend → frontend)

**Критерии завершения:**
- [ ] Работает аутентификация через Google
- [ ] Приложение работает оффлайн (статический контент)
- [ ] Реализован базовый layout с навигацией
- [ ] Firestore сохраняет данные локально при оффлайн
- [ ] Все формы валидируются через Zod схемы
- [ ] Типы генерируются из Zod схем для type safety

---

### Milestone 2 (M2): Базовые сущности и операции (4-5 недели)
**Цель:** Реализовать ядро функционала: счета, категории, операции

**Задачи:**
1. **Модуль счетов (Accounts)**
   - CRUD интерфейс для управления счетами
   - Форма создания/редактирования с валидацией (Zod схемы)
   - Список счетов с балансами в разных валютах
   - Логика автоматического пересчета баланса
   - Архивация счетов

2. **Модуль категорий (Categories)**
   - Иерархический CRUD (древовидная структура)
   - Компонент выбора категории с каскадным dropdown
   - Поддержка типов: income/expense/transfer
   - Возможность задания иконок и цветов

3. **Модуль операций (Operations)**
   - Форма добавления операции с полной валидацией (Zod схемы)
   - Основной список операций с виртуализацией
   - Фильтры: период, категория, счет, теги
   - Сортировка по дате, сумме
   - Пагинация или бесконечный скролл

4. **Локальная аналитика и IndexedDB**
   - Вычисление общего баланса на клиенте
   - Агрегация по категориям за период
   - Настройка IndexedDB для кеширования:
     - Структура БД: stores для операций, категорий, счетов, агрегатов
     - Стратегия синхронизации с Firestore
     - Обработка конфликтов при оффлайн-работе
   - Кеширование агрегированных данных в IndexedDB

**Firestore Security Rules для M2:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /accounts/{accountId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    match /operations/{operationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
```

**Критерии завершения:**
- [ ] Пользователь может создавать/редактировать счета
- [ ] Реализована иерархия категорий
- [ ] Добавление операций работает в оффлайн-режиме
- [ ] Баланс пересчитывается корректно
- [ ] Фильтрация и сортировка операций работают
- [ ] IndexedDB корректно кеширует данные и синхронизируется с Firestore

---

### Milestone 3 (M3): Расширенный функционал (3-4 недели)
**Цель:** Добавить функции для регулярного использования

**Задачи:**
1. **Шаблоны и регулярные операции**
   - CRUD для шаблонов операций
   - Форма настройки регулярности (daily/weekly/monthly)
   - Cloud Function для генерации операций по расписанию
   - Виджет "Ближайшие регулярные платежи"

2. **Система тегов (Tags)**
   - CRUD для тегов
   - Мультиселект тегов при создании операции
   - Автодополнение на основе частоты использования
   - Фильтрация операций по тегам

3. **Модуль валют (Currencies)**
   - Cloud Function для ежедневного обновления курсов
   - Логика конвертации с учетом исторических дат
   - Автоматическое определение базовой валюты
   - Кеширование курсов на клиенте

4. **Виджеты главного экрана**
   - "Ближайшие расходы" (с регулярных шаблонов)
   - "Запланированные операции"
   - Быстрый ввод частых операций
   - Адаптивная сетка виджетов

**Код Cloud Function для валют:**
```javascript
exports.updateCurrencyRates = functions.pubsub
  .schedule('0 2 * * *') // 02:00 UTC ежедневно
  .timeZone('UTC')
  .onRun(async (context) => {
    const rates = await fetchRatesFromAPI('exchangerate.host');
    const batch = firestore.batch();
    const baseCurrency = 'USD';
    
    for (const [code, rate] of Object.entries(rates)) {
      const currencyRef = firestore.doc(`currencies/${code}`);
      batch.set(currencyRef, {
        code,
        name: getCurrencyName(code),
        symbol: getCurrencySymbol(code),
        rates: { [baseCurrency]: 1/rate },
        baseCurrency,
        lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
        source: 'exchangerate.host'
      }, { merge: true });
    }
    
    await batch.commit();
    console.log(`Updated ${Object.keys(rates).length} currency rates`);
  });
```

**Критерии завершения:**
- [ ] Регулярные операции создаются автоматически
- [ ] Теги работают для фильтрации и организации
- [ ] Курсы валют обновляются ежедневно
- [ ] Виджеты главного экрана показывают актуальные данные

---

### Milestone 4 (M4): Аналитика и отчеты (3-4 недели)
**Цель:** Предоставить пользователю аналитику и визуализацию

**Задачи:**
1. **Система агрегированных отчетов**
   - Cloud Function для ежедневной агрегации данных
   - Сохранение сводок в коллекцию `reports/{userId}/{monthKey}`
   - Расчет статистики: траты по категориям, динамика баланса

2. **Визуализация данных**
   - Страница отчетов с Recharts
   - Типы графиков: столбчатые, линейные, круговые
   - Интерактивные элементы графиков (tooltip, zoom)
   - Экспорт графиков в PNG

3. **Расширенные фильтры отчетов**
   - Диапазон дат с пресетами (неделя, месяц, год)
   - Фильтр по нескольким счетам/категориям
   - Группировка по времени (день, неделя, месяц)
   - Сравнение периодов

4. **Дашборд аналитики**
   - Виджеты: баланс, доходы/расходы, топ категорий
   - Адаптивная сетка с drag-and-drop
   - Настройка виджетов дашборда
   - Тёмная/светлая тема для графиков

**Firestore структура для отчетов:**
```javascript
// Коллекция: /reports/{userId}/{year}-{month}
{
  userId: string,
  monthKey: string, // "2024-01"
  periodStart: timestamp,
  periodEnd: timestamp,
  summary: {
    totalIncome: number,
    totalExpense: number,
    netChange: number,
    startBalance: number,
    endBalance: number
  },
  byCategory: {
    [categoryId: string]: {
      categoryName: string,
      amount: number,
      count: number,
      percentage: number
    }
  },
  byAccount: {
    [accountId: string]: {
      accountName: string,
      income: number,
      expense: number,
      netChange: number
    }
  },
  dailyBreakdown: [
    { date: string, income: number, expense: number }
  ],
  generatedAt: timestamp,
  nextUpdate: timestamp
}
```

**Критерии завершения:**
- [ ] Отчеты генерируются автоматически раз в день
- [ ] Графики корректно отображают данные
- [ ] Дашборд настраивается пользователем
- [ ] Экспорт отчетов в CSV работает

---

### Milestone 5 (M5): Полировка и релиз (3-4 недели)
**Цель:** Довести приложение до продакшен-готовности

**Задачи:**
1. **PWA-оптимизации**
   - Генерация манифеста с иконками для всех платформ
   - Настройка стратегий кеширования Workbox
   - Реализация оффлайн-страницы
   - Добавление в дом экрана (iOS/Android)

2. **Всестороннее тестирование**
   - Unit-тесты для утилит и хуков (Jest)
   - E2E тесты ключевых сценариев (PlayWright)
   - Тестирование оффлайн-поведения
   - Load-тестирование Firestore правил

3. **Производительность**
   - Аудит Lighthouse (цель: 90+ по всем метрикам)
   - Code splitting для маршрутов (React.lazy, динамические импорты)
   - Оптимизация bundle size (анализ через webpack-bundle-analyzer)
   - Ленивая загрузка тяжелых компонентов (Recharts, графики)
   - Оптимизация изображений (WebP, lazy loading)

4. **Мониторинг и аналитика**
   - Настройка Sentry для отлова ошибок
   - Настройка Cloud Logging для структурированного логирования
   - Firebase Analytics для пользовательской аналитики
   - Мониторинг лимитов Firestore
   - Логирование ключевых действий (структурированные логи)
   - Health checks для критических сервисов

5. **Accessibility и UX**
   - Полный аудит accessibility (a11y)
   - Реализация ARIA атрибутов для всех интерактивных элементов
   - Обеспечение keyboard navigation для всех функций
   - Тестирование с screen readers
   - Оптимизация для мобильных устройств (touch targets, gestures)

6. **Релиз и документация**
   - Деплой на продакшен
   - Создание документации для пользователей
   - Политика конфиденциальности
   - Подготовка FAQ и гайдов

**Критерии завершения:**
- [ ] PWA проходит все аудиты Lighthouse
- [ ] Test coverage > 80% для критического кода
- [ ] Нет critical ошибок в Sentry
- [ ] Приложение опубликовано и доступно по домену
- [ ] Accessibility score > 90 в Lighthouse
- [ ] Cloud Logging настроен и работает
- [ ] Все формы и API валидируются через Zod

---

## Критические моменты и рекомендации

### 1. Оффлайн-синхронизация
**Проблема:** Конфликты при синхронизации после оффлайн-работы  
**Решение:** 
- Реализовать поле `version` для optimistic concurrency control
- Использовать `serverTimestamp` для единой временной шкалы
- Реализовать очередь операций для оффлайн
- Визуально помечать несинхронизированные данные

### 2. Безопасность данных
**Проблема:** Защита пользовательских данных в мультитенантной среде  
**Решение:**
- Детализированные Firestore Security Rules
- Валидация данных через Zod схемы в Cloud Functions перед записью
- Генерация TypeScript типов из Zod для end-to-end type safety
- Хеширование балансов для обнаружения расхождений
- Регулярные аудиты правил доступа

### 3. Оптимизация лимитов Firestore
**Проблема:** Превышение квот (50к reads/день)  
**Решение:**
- Агрегация данных в Cloud Functions
- Кеширование отчетов в отдельной коллекции
- Пагинация с cursor-based навигацией
- Композитные индексы для всех запросов

### 4. Производительность UI
**Проблема:** Медленная работа с большими списками операций  
**Решение:**
- Виртуализация списков (react-window)
- Ленивая загрузка исторических данных
- Дебаунсинг фильтров и поиска
- Оптимистичные обновления UI

## Оценка временных затрат

| Этап | Длительность | Основные риски |
|------|--------------|----------------|
| M0   | 2-3 недели   | Настройка CI/CD, Firebase |
| M1   | 3-4 недели   | Оффлайн-синхронизация, Auth |
| M2   | 4-5 недель   | Сложность бизнес-логики операций |
| M3   | 3-4 недели   | Cloud Functions, регулярные операции |
| M4   | 3-4 недели   | Производительность графиков |
| M5   | 3-4 недели   | PWA оптимизации, тестирование |

**Общая оценка:** 18-24 недели для команды из 2-3 разработчиков

## Приоритизация для MVP

Если требуется сократить сроки, рекомендуется следующая последовательность:

1. **Ядро MVP** (M0 + M1 + M2 без архивации и расширенных фильтров)
   - Аутентификация
   - Базовые CRUD для счетов, категорий, операций
   - Оффлайн-работа
   - Расчет баланса

2. **Критичные улучшения** (из M3)
   - Регулярные операции (шаблоны)
   - Базовая валюта (без исторических курсов)

3. **Аналитика** (упрощенная версия M4)
   - Статические отчеты без ежедневной агрегации
   - Простые графики на клиенте

4. **Полировка** (выборочно из M5)
   - PWA манифест
   - Базовое тестирование
   - Деплой

Такая схема позволит выпустить работающий продукт за 10-12 недель.

---

## Мониторинг после релиза

1. **Метрики производительности:**
   - Время загрузки приложения
   - Количество ошибок синхронизации
   - Среднее время операций CRUD

2. **Бизнес-метрики:**
   - Активные пользователи (DAU/MAU)
   - Глубина использования (операций/пользователя)
   - Процент оффлайн-использования

3. **Технические метрики:**
   - Использование Firestore (reads/writes)
   - Частота превышения квот
   - Эффективность кеширования

---
